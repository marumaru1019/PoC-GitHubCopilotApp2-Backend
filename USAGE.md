# 使い方ガイド

このドキュメントでは、ヘルプデスク & ナレッジベースシステムの使い方を説明します。

## 目次

1. [初回セットアップ](#初回セットアップ)
2. [ログイン](#ログイン)
3. [チケット管理](#チケット管理)
4. [ナレッジベース](#ナレッジベース)
5. [管理機能](#管理機能)
6. [ロール別機能](#ロール別機能)

---

## 初回セットアップ

### Docker環境を使う場合（推奨）

```bash
# 1. 全サービスを起動
docker-compose up -d

# 2. データベースの初期化
docker-compose exec backend alembic upgrade head

# 3. 初期データの投入
docker-compose exec backend python seed.py

# 4. ブラウザでアクセス
# Frontend: http://localhost:3000
# Backend API: http://localhost:8000
# API Docs: http://localhost:8000/docs
```

### ローカル環境を使う場合

```bash
# Backend
cd backend
python -m venv venv
venv\Scripts\activate
pip install -r requirements.txt
alembic upgrade head
python seed.py
uvicorn app.main:app --reload

# Frontend（別のターミナル）
cd frontend
npm install
npm run dev
```

---

## ログイン

### テストアカウント

システムには3種類のロールがあります：

| ロール | メールアドレス | パスワード | 権限 |
|--------|---------------|-----------|------|
| **管理者（Admin）** | admin@example.com | admin123 | すべての機能を利用可能 |
| **オペレーター（Operator）** | operator@example.com | operator123 | チケット対応、KB記事作成 |
| **一般ユーザー（Requester）** | user@example.com | user123 | チケット作成、KB閲覧 |

### ログイン手順

1. ブラウザで http://localhost:3000/login にアクセス
2. メールアドレスとパスワードを入力
3. 「ログイン」ボタンをクリック
4. ダッシュボード（ホーム画面）にリダイレクト

---

## チケット管理

### チケットの作成（全ユーザー）

1. ヘッダーの「チケット」をクリック
2. 「新規チケット」ボタンをクリック
3. 以下の情報を入力：
   - **タイトル**（必須）
   - **説明**（必須）
   - **優先度**: 低/中/高/緊急
   - **カテゴリ**: 問い合わせの種類を選択
   - **タグ**: 関連するタグを選択（複数可）
4. 「作成」ボタンをクリック

### チケットの閲覧

#### チケット一覧

- **フィルター機能**:
  - ステータス: 新規/対応中/顧客待ち/解決済み/クローズ
  - 優先度: 低/中/高/緊急
  - カテゴリ
  - 担当者（オペレーター/管理者のみ）

- **表示情報**:
  - チケットID
  - タイトル
  - ステータス（バッジ表示）
  - 優先度（バッジ表示）
  - 作成者
  - 担当者
  - 作成日時

#### チケット詳細

チケットをクリックすると詳細画面に移動します：

- **基本情報**:
  - タイトル、説明
  - ステータス、優先度
  - カテゴリ、タグ
  - 作成者、担当者、チーム

- **SLA情報**（オペレーター/管理者のみ）:
  - 初回応答時間（FRT）
  - 経過時間
  - 目標時間
  - 残り時間

- **コメント履歴**:
  - すべてのコメントと返信を表示
  - 公開コメントと内部メモを区別

### チケットへのコメント追加

1. チケット詳細画面の下部にあるコメント欄に内容を入力
2. **コメントタイプを選択**:
   - **公開**: 一般ユーザーも閲覧可能
   - **内部メモ**: オペレーター/管理者のみ閲覧可能
3. 「コメント送信」ボタンをクリック

💡 **Tips**: 
- 初回の公開コメントが投稿されると、自動的にFRT（初回応答時間）が記録されます
- 内部メモは情報共有やメモ用途に使用してください

### チケットの更新（オペレーター/管理者のみ）

1. チケット詳細画面の「編集」ボタンをクリック
2. 以下を変更可能：
   - タイトル、説明
   - 優先度
   - カテゴリ、タグ
3. 「更新」ボタンをクリック

### ステータス変更

**オペレーター/管理者**:
- 「ステータス変更」ドロップダウンから新しいステータスを選択
- 状態遷移のルール:
  - `NEW` → `IN_PROGRESS` (対応開始)
  - `IN_PROGRESS` → `WAITING_CUSTOMER` (顧客待ち)
  - `IN_PROGRESS` → `RESOLVED` (解決済み)
  - `WAITING_CUSTOMER` → `IN_PROGRESS` (対応再開)
  - `RESOLVED` → `CLOSED` (クローズ)

**一般ユーザー**:
- `WAITING_CUSTOMER` → `IN_PROGRESS` (追加情報を提供した場合)
- `RESOLVED` → `CLOSED` (解決を確認した場合)

### 担当者の割り当て（オペレーター/管理者のみ）

1. チケット詳細画面の「担当者割当」セクションへ
2. 担当者またはチームを選択
3. 「割り当て」ボタンをクリック

---

## ナレッジベース

### KB記事の閲覧（全ユーザー）

1. ヘッダーの「ナレッジベース」をクリック
2. **記事一覧**:
   - カテゴリ別にフィルタ可能
   - タグで絞り込み可能
   - 人気記事（閲覧数順）を表示
3. 記事をクリックして詳細を閲覧

### KB記事の作成（オペレーター/管理者のみ）

1. ナレッジベースページの「新規記事」ボタンをクリック
2. 以下の情報を入力：
   - **タイトル**（必須）
   - **本文**（必須、Markdown形式対応）
   - **カテゴリ**
   - **タグ**（複数選択可能）
3. **ステータスを選択**:
   - **下書き**: 編集中の記事（非公開）
   - **公開**: すべてのユーザーが閲覧可能
4. 「作成」ボタンをクリック

### KB記事の編集（オペレーター/管理者のみ）

1. 記事詳細画面の「編集」ボタンをクリック
2. 内容を修正
3. 「更新」ボタンをクリック

### 記事の公開/非公開（オペレーター/管理者のみ）

- **公開**: 記事詳細画面の「公開」ボタンをクリック
- **非公開**: 記事詳細画面の「非公開にする」ボタンをクリック
- **アーカイブ**: 「削除」ボタンで記事をアーカイブ（論理削除）

💡 **Tips**:
- 記事の閲覧数は自動的にカウントされます
- Markdown記法を使って、見出し、リスト、コードブロックなどを整形できます

---

## 管理機能

管理機能は**管理者ロール**のみが利用できます。

### ユーザー管理

1. ヘッダーの「管理」→「ユーザー管理」をクリック
2. **新規ユーザー作成**:
   - 「新規ユーザー」ボタンをクリック
   - 名前、メールアドレス、パスワード、ロールを入力
   - 所属チームを選択（任意）
3. **ユーザー編集**:
   - ユーザー行の「編集」ボタンをクリック
   - 情報を更新

### チーム管理

1. 「管理」→「チーム管理」をクリック
2. **新規チーム作成**:
   - 「新規チーム」ボタンをクリック
   - チーム名、説明を入力
3. **チーム編集**:
   - チーム行の「編集」ボタンをクリック
   - 情報を更新

### カテゴリ管理

1. 「管理」→「カテゴリ管理」をクリック
2. **新規カテゴリ作成**:
   - 「新規カテゴリ」ボタンをクリック
   - カテゴリ名、説明、タイプ（チケット/記事/両方）を入力
3. **カテゴリ編集**:
   - カテゴリ行の「編集」ボタンをクリック

### タグ管理

1. 「管理」→「タグ管理」をクリック
2. **新規タグ作成**:
   - 「新規タグ」ボタンをクリック
   - タグ名を入力
3. タグの追加/削除が可能

### SLA設定

1. 「管理」→「SLA設定」をクリック
2. **SLA設定の作成/編集**:
   - 優先度ごとに目標時間を設定
   - **初回応答時間（FRT）**: 最初のコメントまでの目標時間
   - **解決時間**: チケット作成から解決までの目標時間
   - 時間は分単位で設定

**デフォルトのSLA設定**:

| 優先度 | 初回応答時間 | 解決時間 |
|--------|-------------|---------|
| 緊急 | 15分 | 240分（4時間） |
| 高 | 60分 | 480分（8時間） |
| 中 | 240分（4時間） | 1440分（24時間） |
| 低 | 480分（8時間） | 2880分（48時間） |

💡 **Tips**:
- `WAITING_CUSTOMER`ステータスの間はSLA計測が停止します
- SLA超過はチケット一覧で警告表示されます

### 監査ログ

1. 「管理」→「監査ログ」をクリック
2. **フィルター機能**:
   - エンティティタイプ: ユーザー/チケット/記事など
   - アクション: 作成/更新/削除/公開など
   - ユーザー別
   - 期間指定
3. **表示情報**:
   - 実行日時
   - 実行ユーザー
   - アクション
   - エンティティ
   - 変更内容（JSON形式）

💡 **Tips**:
- 監査ログは読み取り専用で、変更・削除できません
- すべての重要な操作が自動的に記録されます

---

## ロール別機能

### 一般ユーザー（Requester）

✅ **できること**:
- チケットの作成
- 自分が作成したチケットの閲覧
- チケットへの公開コメント投稿
- チケットステータスの一部変更（`WAITING_CUSTOMER` → `IN_PROGRESS`, `RESOLVED` → `CLOSED`）
- KB記事の閲覧

❌ **できないこと**:
- 他人のチケットの編集
- チケットの担当者割り当て
- KB記事の作成・編集
- 内部メモの閲覧・投稿
- 管理機能へのアクセス

### オペレーター（Operator）

✅ **一般ユーザーの権限に加えて**:
- すべてのチケットの閲覧・編集
- チケットの担当者割り当て
- すべてのステータス変更
- 内部メモの閲覧・投稿
- KB記事の作成・編集・公開
- KB記事の削除（アーカイブ）

❌ **できないこと**:
- ユーザー管理
- チーム管理
- カテゴリ・タグ管理
- SLA設定
- 監査ログ閲覧

### 管理者（Admin）

✅ **すべての権限**:
- オペレーターのすべての権限
- ユーザー管理（作成・編集）
- チーム管理（作成・編集）
- カテゴリ管理（作成・編集）
- タグ管理（作成・編集・削除）
- SLA設定（作成・編集）
- 監査ログ閲覧

---

## よくある使用シーン

### シーン1: 新しい問い合わせ対応

1. **一般ユーザー**: チケット作成（タイトル、説明、優先度を設定）
2. **オペレーター**: チケットを確認し、担当者に割り当て
3. **オペレーター**: ステータスを`IN_PROGRESS`に変更
4. **オペレーター**: 公開コメントで回答（FRTが記録される）
5. **一般ユーザー**: 追加情報を提供（ステータスが自動的に戻る）
6. **オペレーター**: 問題を解決し、ステータスを`RESOLVED`に変更
7. **一般ユーザー**: 解決を確認し、`CLOSED`に変更

### シーン2: よくある質問をKB化

1. **オペレーター**: 繰り返し同じ質問が来ることに気づく
2. **オペレーター**: KB記事を作成（下書き状態）
3. **オペレーター**: 内容をレビュー・編集
4. **オペレーター**: 記事を公開
5. **一般ユーザー**: KB記事を閲覧し、自己解決

### シーン3: SLA管理

1. **管理者**: 優先度別のSLA設定を定義
2. **オペレーター**: 高優先度チケットが入ってきたら、SLA時間内に初回応答
3. **システム**: 顧客待ちの間はSLA計測を停止
4. **オペレーター**: 期限内に解決を目指す
5. **管理者**: 監査ログとレポートでSLA達成率を確認

---

## トラブルシューティング

### ログインできない

- メールアドレスとパスワードが正しいか確認
- 初期ユーザーを使用している場合、seed.pyが実行されているか確認
- Backendが起動しているか確認（http://localhost:8000/docs にアクセス）

### チケット/記事が表示されない

- フィルターが適用されていないか確認
- ロールの権限を確認（一般ユーザーは自分のチケットのみ表示）
- ブラウザのキャッシュをクリア

### 担当者に割り当てできない

- 担当者がオペレーターまたは管理者ロールか確認
- 自分がオペレーター/管理者権限を持っているか確認

### SLAが計測されない

- SLA設定が正しく作成されているか確認（管理画面）
- チケットの優先度が設定されているか確認
- 監査ログで状態遷移を確認

---

## API利用

開発者向けに、APIドキュメントを提供しています：

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

### 認証

すべてのAPIエンドポイントは、JWT認証が必要です：

```bash
# ログイン
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@example.com","password":"admin123"}'

# レスポンス
{
  "access_token": "eyJhbGc...",
  "token_type": "bearer"
}

# APIリクエスト
curl -X GET "http://localhost:8000/api/tickets" \
  -H "Authorization: Bearer eyJhbGc..."
```

詳細なAPIエンドポイントはREADME.mdを参照してください。

---

## まとめ

このシステムでは、チケット管理とナレッジベースを統合し、効率的な問い合わせ対応と知見蓄積を実現できます。

- **一般ユーザー**: 問い合わせを投稿し、KB記事で自己解決
- **オペレーター**: チケット対応とKB記事作成で顧客サポート
- **管理者**: ユーザー管理とSLA設定で運用最適化

ご不明な点があれば、管理者にお問い合わせください。
